### 2.生成、打包、部署和管理应用程序及类型

#### 2.1 .NET Framework部署目标

    Windows不稳定和口碑不佳的原因：

        1.所有应用程序都使用来自Microsoft或其他厂商的动态链接库（DLL）。当对于用户，当一
        家公司决定更新其软件产品的代码，并将新文件发送给他们是，就可能出现问题。还有可能安
        装新的应用程序时，他可能莫名其妙的破坏了另一个已经安装好的应用程序。这就是所谓的“
        DLL hell"

        2.安装的复杂性。大多数应用程序在安装时都会影响到系统的全部组件。例如，安装一个应用
        程序会将文件复制到多个目录，更新注册表并在桌面和开始菜单安装快捷方式。应用程序备份
        也不容易，想要复制只有再次运行安装程序才能确保正确。最后即时卸载了，也可能不干净

        3.安全性。安装应用程序会带来各种文件，其中有许多是由不同公司开发的，他们可能会造成
        各种各样的危害。

    小结：
        部署目标：
            1.NET Framework正在尝试彻底解决 DLL hell
            2.NET Framework在很大程度上解决了应用程序状态在硬盘中四处分散的问题
            3.安全性方面，.NET Framework包含称为“代码访问安全性”的安全模型，.NET Framew
            ork允许用户灵活控制那些东西能够安装，那些东西能够允许。

#### 2.2 将类型生成到模块中

    通过csc.exe来生成可执行文件 .exe
    csc.exe /out:Program.exe /t:exe /r:MSCorLib.dll Program.cs

    .exe这个文件到底是什么？
        首先它是标准PE（可移植执行体）文件，这意味着windows计算机能加载他，并通过他执行某
        些操作。

    Windows支持三种应用程序：
        CUI 
        GUI 
        Windows Store应用

#### 2.3 元数据概述

    托管PE文件由4部分构成：

        第一部分：
            PE32(+)头:Windows要求的标准信息
        第二部分：
            CLR头:是一个小的信息块，是需要CLR的模块特有的。这个头包含了：
                模块生成时所面向的CLR的major(主)和minor(次)版本号;
                一些标志(flag);
                一个MethodDef token,该token指定了模块的入口方法(前提是该模块式CUI、G
                UI或Windows Store执行体);
                一个可选的强名称数字签名;
                模块内部的一些元数据表的大小和偏移量
        第三部分：
            元数据
        第四部分：
            IL
    
    元数据是由几个表构成的二进制数据块。有三种表，分别是定义表、引用表和清单表。

    定义表：
        编译器编译源代码时,代码所定义的任何东西都都导致在元数据定义表中的某个表中创建一个
        记录项。
    
    引用表：
        此外编译器还会检测源代码引用的类型、字段、方法、属性和事件,并创建相应的元数据表记
        录项。该表记录了所引用的内容。

    清单表：
        表中主要包含作为程序集组成部分的那些文件的名称。还描述了程序集的版本、语言文化、发
        布者、公开导出的类型以及构成程序集的所有文件。

    Program.exe包含名为Program的TypeDef。Program是公共密封类，从System.Object派生,Pro
    gram类型还定义了两个方法：Main和.ctor(构造器)

#### 2.4 将模块合并成程序集

    Program.exe并非是只含有元数据的PE文件,它还是程序集。

    程序集（assembly）：
        是一个或多个类型定义文件及资源文件的集合。在程序集的所有文件中，有一个文件容纳了清
        单。

    CLR操作的是程序集。换言之,CLR总是首先加载包含“清单”元数据表的文件，在根据“清单”来获取
    程序集中的其他文件的名称。

    程序集的特点：
        程序集定义了可重用的类型
        程序集用一个版本号标记
        程序集可以关联安全信息
    除了包含清单元数据表的文件、程序集其他单独的文件并不具备上述特点

    为了配置应用程序去下载程序集文件，可在应用程序配置文件中指定codeBase元素。

    使用多文件程序集的三点理由：

        1.不同类型用不同的文件，使文件能以“增量”方式下载。另外，将类型划分到不同的文件中，
        可以对购买或者安装的应用程序进行部分或分批打包/部署

        2.可在程序集中添加资源或数据文件。

        3.程序集包含的各个类型可以用不同的编程语言来实现。

    程序集是进行重用、版本控制和应用安全性设置的基本单元。一旦CLR加载含有清单的文件，就可
    以确定在程序集的其他文件中，具体是哪一些文件包含应用程序引用的类型和资源。

    由于有了清单的存在，程序集的用户不必关系程序集的划分细节。另外清单也使程序集具有了自描
    述性。

#### 2.5 程序版本的资源信息

    生成程序集的时候，应该使用定制特性设置各种版本资源字段，这些特性在源代码中应用于assemb
    ly级别。

    using System.Reflection;

    //FileDescription 版本信息
    [assembly:AssemblyTitle("MultiFileLibrary.dll")]

    //Comments 版本信息
    [assembly:AssemblyDescription("This assembly contain MultiFileLibrary's type")]

    //CompanyName 版本信息
    [assembly:AssemblyCompany("Wintellect")]

    //ProductName 版本信息
    [assembly:AssemblyProduct("Wintellect (R) MultiFileLibrary's Type Library")]

    //LegalCopyright 版本信息
    [assembly:AssemblyCopyright("Copyright (c) Wintellect 2013")]

    //LegalTrademarks 版本信息
    [assembly:AssemblyTrademark("MultFileLibrary is a registered trademark of Wi")]

    //AssemblyVersion 版本信息
    [assembly:AssemblyVersion("3.0.0.0")]

    //FILEVERSION/FileVersion 版本信息
    [assembly:AssemblyFileVersion("1.0.0.0")]

    //PRODUCTVERSION/Productversion 版本信息
    [assembly:AssemblyInformationalVersion("2.0.0.0")]

    //设置Language字段(语言文化)
    [assembly:AssemblyCulture("")]
    
    AssemblyVersion CLR加载程序集时会使用这个值

    版本号：
        所有的版本号都具有相同的格式，每个都包含4个以据点分隔的部分

             major(主版本号)  minor(次版本号)  build(内部版本号)  revision(修订号)
        示例：2                 5               719                 2
    
    前两个编号构成了公众对版本的理解。公众会将这个例子看成是程序集的2.5版本。第三个编号
    719是程序集的编号，如果公司每天都生成程序集，那么每天都应该递增这个build号。最后一个
    2之处当前build的修订次数。如果因为某个原因，公司某一天必须生成两次程序集，revision号
    就应该递增。

    程序集有三个版本号：

        AssemblyFileVersion
            这个版本号存储在Win32版本资源中。他仅供参考，CLR既不检查，也不关心这个版本号
            通常，可以先设置好版本号的major/minor部分，这是希望公众看到的版本号。然后每
            生成一次就递增buile和revision部分。在Windows资源管理器中能看到这个版本号。对
            客户系统进行故障诊断时，可根据它识别程序集的版本是多少。

        AssemblyInformationalVersion
            这个版本号也存储在Win32版本资源中，同样仅供参考。CLR既不检查也不关心它。这个
            版本号的作用是指出包含该程序集的产品版本。例如，产品的2.0版本可能包含这个几个
            程序集，其中一个程序集标记为版本1.0，因为他是新开发的，在产品的1.0版本中不存
            在。通常，可以设置这个版本好的major和minor部分来代表产品的公开版本。以后每次
            打包所有程序集来生成完整产品，就递增build和revision部分。

        AssemblyVersion
            这个版本号存储在AssemblyDef清单元数据表中。CLR在绑定到强命名程序集时会用到它
            这个版本号很重要，它唯一性地标识了程序集。开始开发程序集时，应该设置好major/
            minor/build/revision部分。而且除非要开发程序集的下一个可部署版本，否则不应该
            变动。如果程序集A引用了强命名程序集B，程序集B的版本对嵌入程序集A的AssemblyRe
            f表。这样一来，当CLR需要加载程序集B时，就准确地知道当初生成和测试的是程序集B
            的那个版本。

#### 2.6 语言文化

    程序集也将语言文化作为其身份标识的一部分。创建含代码的程序集一般不指定具体的语言文化。
    因为代码只讲逻辑不涉及具体的语言文化。未指定具体语言文化的程序集称为语言文化中性。

    如果应用程序包含语言文化特有的资源，Microsoft强烈建议专门创建一个程序集来包含代码和应
    用程序的默认资源。生成该程序集时不要指定具体的语言文化。其他程序集通过引用该程序集来创
    建和操纵它公开的类型。

    一般不要生成引用了附属程序集的程序集。换言之，程序集的AssemblyRef记录项只应引用用语言
    文化中性的程序集。要访问附属程序集中的类型或成员，应使用反射技术。

#### 2.7 简单应用程序部署(私有部署的程序集)

    WindowsStore的桌面应用，程序集的打包方式没有任何特殊要求。打包一组程序集最简单的方式
    就是直接复制所有文件。

    也可以使用其他机制打包和安装程序集文件，比如使用.cab文件(目的在于压缩文件并缩短下载时
    间)。还可以将程序打包成一个MSI文件，以便由WindowsInstaller服务（MSIExec.exe）使用。

    在应用程序基目录或者子目录部署的程序集称为私有部署的程序集，这是因为程序集文件不和任何
    其他应用程序共享（除非其他应用程序也部署到该目录）。只需要把它复制到一个应用程序基目录
    CLR便会加载并执行其中的代码。要卸载直接删除目录中的程序集就可以了。

    之所以能够实现简单的安装/移动/卸载，是因为每个程序集都用元数据注明了自己引用的程序集，
    不需要注册表设置。另外，引用（别的程序集）程序集限定了每个类型的作用域。也就是说，一
    个应用程序总是和它生成和测试时的类型绑定。即便另一个程序集恰好提供了同名类型，CLR也不
    能加载那个程序集。这一点有别于COM。在COM中，类型是在注册表中登记的，造成机器上运行的任
    何应用程序都能使用那些类型。

#### 2.8 简单管理控制（配置）

    用户或管理员经常需要控制应用程序的执行。例如，管理员可能决定移动用户硬盘上的程序集文件
    或者覆写程序集清单中的信息。为了实现对应用程序的管理控制，可在应用程序目录放入一个配置
    文件。应用程序的发布者可创建并打包该文件。安装程序会将配置文件安装到应用程序的基目录。
    另外，计算机管理员或者最终用户也能创建或修改该文件。CLR会解析文件内容来更改程序集文件
    的定位和加载策略。

    配置文件包含XML代码，它既能和应用程序关联，也能和机器关联。由于是一个单独的文件，用户
    可以方便的备份文件

    不能用相对路径或者绝对路径指定在应用程序基目录外部的目录。这个设计的出发点是应用程序能
    控制它的目录及子目录，但不能控制其他目录

    这个XML配置文件的名称和位置取决于应用程序的类型
        对于可执行应用程序（EXE）:
            配置文件必须在应用程序的基目录，而且必须采用EXE文件全名作为文件名，在附加.con
            fig扩展名
        
        对于Microsoft ASP.NET Web窗体应用程序：
            文件必须在Web应用程序的虚拟根目录中，而且总是命名为Web.config

    配置设置既可以应用于程序，也可以应用于机器。.NET Framework在安装时会创建一个Machine.
    config文件




            
